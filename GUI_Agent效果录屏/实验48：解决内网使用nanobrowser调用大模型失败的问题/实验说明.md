# 实验背景

在内网使用nanobrowser，调用大模型失败

# 实验目标

解决内网使用nanobrowser调用大模型失败的问题

# 实验步骤

## 分析线索

- 在外网调用成功。
- 外网用的是qwen-plus模型
- 内网调用的是 qwen3-235b-a22b
- 内网中planner调用成功
- 内网中 navidator 调用失败
- 内网中 navigator 首次调用成功
- 内网中 navigator （第二次或第三次或第四次）调用失败
    - 说明有第三次调用成功的情况。
- 报错位置为：

```typescript
response = await structuredLlm.invoke(inputMessages, {
    signal: this.context.controller.signal,
    ...this.callOptions,
})
```

## 可能的原因

- structuredLlm.invoke 与 qwen3-235b-a22b 不兼容？
- 工具调用的问题？
- 长度的问题？

- 报错为 500 错误。

## 进展

碰到张旭。他说之前碰到过这种问题，明天问建诚。他那里能看到日志。

# 实验结果

中止，因为意识到有更重要的事情，就是做PPT。

# 实验继续

## 实验背景

PPT已经做完。与建诚联调，发现的是另外的问题，235b模型胡言乱语，导致 planner 也过不去。重启，需要1小时。然后用 qwen-vl-30b-a3b-thinking，复现了以前的错误。

## 实验目的

解决内网 agent 调用大模型的问题

## 实验步骤

### 网上查看千问开源模型的工具调用能力

问gemini： qwen3-235b-a22b 具有工具调用能力吗？

问 gemini：structuredLlm 是什么？

```typescript
import type { BaseChatModel } from '@langchain/core/language_models/chat_models';
export abstract class BaseAgent{
    protected chatLLM: BaseChatModel;
    const structuredLlm = this.chatLLM.withStructuredOutput(this.modelOutputSchema, {
        includeRaw: true,
        name: this.modelOutputToolName,
        });
    response = await structuredLlm.invoke(inputMessages, {
        signal: this.context.controller.signal,
        ...this.callOptions,
    });
}

import { BaseAgent, type BaseAgentOptions, type ExtraAgentOptions } from './base';
export class NavigatorAgent extends BaseAgent<z.ZodType, NavigatorResult> {
}
    super(actionRegistry.setupModelOutputSchema(), options, { ...extraOptions, id: 'navigator' });
    this.actionRegistry = actionRegistry;
    // The zod object is too complex to be used directly, so we need to convert it to json schema first for the model to use
    this.jsonSchema = convertZodToJsonSchema(this.modelOutputSchema, 'NavigatorAgentOutput', true);
```

## 思路

最小代码复现核心代码然后调试

## 思路

要想跑通 235b，需要什么呢？

curl 调用 qwen3-235b-a22b，如何进行结构化输出和工具调用

每个模型进行工具调用和结构化调用的方法都不一样。得看文档才能知道有什么区别

如果是一个非常老旧的模型，不支持工具调用和结构化输出，但是支持openai接口，我用openai接口方式调用，会怎样？

如果是一个非常老旧的模型，不支持工具调用和结构化输出，但是支持openai接口，我用langchain，指定输出模式和工具，会怎样？

是 qwen3-235b-a22b 这个模型的问题吗？我通过互联网调用这个模型试试

qwen3-235b-a22b
sk-efe1c9004f7e4de0a8ade26120301c6d
https://dashscope.aliyuncs.com/compatible-mode/v1

Planning failed: Failed to invoke qwen3-235b-a22b with structured output: 
400 <400> InternalError.Algo.InvalidParameter: Json mode response is not supported when enable_thinking is true

但是内网没有这个错误。说明什么？

1. 点击 文本模型 按钮
2. 点击 语音模型 按钮
3. 点击 视觉模型 按钮
4. 点击 全模态模型 按钮
5. 点击 模型调优 按钮
6. 点击 我的模型 按钮
——互联网上 qwen3-235b-a22b-instruct-2507 可成功执行。


???????楚一 agent langchain string 改成 false ？？？？？？？？？？？？？？？/

## 思路：运行最小可行代码

### 解决在哪里运行代码的问题

chrome 控制台可以执行 TS 代码：不行。

在互联网上运行了，在内网呢？

## 思路：获取发送给大模型的json数据

非常神奇获取到了！！！

### 阶段性成果

已经写好了 curl 命令（非常长）。但是想复制到cmd中运行，发现因为命令太长了，所以复制不完整。怎么办？

解决方案：保存成bat

### 阶段性成果

在传送给大模型的Messages数组中，assistant后面接tool就成功，否则失败。如下 assistant 信息后面没有 tool：

```json
{
    "observation": "I need to analyze the current situation. The user has given me a new task: \"在搜索框输入 你好\" which means \"Enter '你好' in the search box\" in Chinese. This appears to be a web browsing task that requires interacting with a search box on a webpage. However, I don't have any context about what webpage we're currently on or what search box we need to interact with.",
    "challenges": "1. No information about current webpage or search box location\n2. Don't know which search box the user is referring to\n3. Need to identify the appropriate search box on the current page\n4. May need to navigate to a page with a search box first",
    "done":false, "next_steps":"1. First, examine the current webpage to see if there's a search box visible\n2. If a search box is found, input \"你好\" into it\n3. If no search box is visible, search for a page with a search box (like Google or Baidu)\n4. Navigate to a search engine page and enter \"你好\" in the search box",
    "final_answer":"",
    "reasoning":"The user's task is to enter \"你好\" (Chinese for \"hello\") into a search box. Since this is a web browsing task that requires interacting with webpage elements, I need to first understand what page we're on and locate a search box. If there's no search box on the current page, I'll need to navigate to a search engine page like Google or Baidu to complete the task.",
    "web_task":true
}
```

补充：后来，我在调用其他模型的时候也碰到类似问题：❌ 请求失败: An assistant message with 'tool_calls' must be followed by tool messages responding to each 'tool_call_id'. (insufficient tool messages following tool_calls message)

导致上面两种现象的原因相同吗？其原理是什么？

因此接下来，要么换一个agent，要么换一个大模型。

### 换 browseros

先测试最新版软件的可用性
- 安装包可用性
    - windows：在互联网上，v0.35.0可用。v0.36.0可用。在内网不行，因为要先访问互联网：bit.ly/BrowserOS-setup。提示：BrowserOS Agent is installing/updating. Please try again shortly.
- 大模型可用性
    - deepseek：可用
        - provider: oepnai-competible
        - model_name: deepseek-chat
        - base_url: https://api.deepseek.com
        - api_key: sk-6fda4f18a54140c6ae408fdd13cfe97d

### 换大模型

必须去所内网
- 需要让人指导
	- 张旭/李健诚：not avaliable now
- 秦城断电了，现在连不上

### 接下来干什么？

能不能改造一下browseros-agent？之前研究过。哪个实验来着？实验41做过。我再做一遍。

## 实验结果

中止。因为所内服务器还不能用。

## 未来计划

在 windows 验证单独使用 browseros-agent 的可行性