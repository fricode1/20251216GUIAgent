# 任务背景

百度网关对messages进行了审核，要求必须符合如下格式：

```text
user - assistant - user - assistant - user - …
```

这与 nanobrowser 消息格式不兼容

# 任务目的

修改nanobrowser代码，使得消息历史符合严格格式。

# 任务步骤

## 基本思路

在两个 assistant 之间，找个合适的位置，加入一条 user 信息。

## 下载源码

必须位于非中文、无空格路径，否则将来编译代码时的`pnpm dev`命令报错。

```powershell
git clone https://github.com/nanobrowser/nanobrowser.git
```

## 需要重点关注的代码逻辑

executor.ts

```typescript
runPlanner()
    planOutput = this.planner.execute()
    this.context.messageManager.addPlan(JSON.stringify(planOutput.result), positionForPlan);
```

service.ts

```typescript
class MessageManager{
    addPlan(){
        const msg = new AIMessage({ content: `<plan>${cleanedPlan}</plan>` })
        this.addMessageWithTokens(msg, null, position)
    }
    addMessageWithTokens(){
        this.history.addMessage(filteredMessage, metadata, position)
    }
}
```

views.ts

```typescript
class MessageHistory{
    addMessage(){
        if (position === undefined) {
            this.messages.push(managedMessage);
        } else {
            this.messages.splice(position, 0, managedMessage);
        }
    }
}
```

## 需要改动的地方

service.ts

```typescript
class MessageManager{
    addPlan(){
        const msg = new AIMessage({ content: `<plan>${cleanedPlan}</plan>` })
        this.addMessageWithTokens(msg, null, position)

        // start: 增加一条人类消息，以满足严格历史模式
        const msg_human = new HumanMessage({content: "The preivous message is the plan message."})
        this.addMessageWithTokens(msg_human, null)
        // end: 增加一条人类消息，以满足严格历史模式
    }
}
```


## 编译

```powershell
cd nanobrowser
pnpm install --registry=https://registry.npmmirror.com  # 国内加速非常有效
pnpm dev
```

报错：

```powershell
(base) PS C:\Users\admin\Documents\GitHub\fri\20251216GUIAgent\code\nanobrowser> pnpm dev

> nanobrowser@0.1.13 dev C:\Users\admin\Documents\GitHub\fri\20251216GUIAgent\code\nanobrowser
> turbo ready && cross-env __DEV__=true turbo watch dev --concurrency 20

╭──────────────────────────────────────────────────────────────────────────╮
│                                                                          │
│                     Update available v2.6.1 ≫ v2.7.4                     │
│    Changelog: https://github.com/vercel/turborepo/releases/tag/v2.7.4    │
│          Run "pnpm dlx @turbo/codemod@latest update" to update           │
│                                                                          │
│          Follow @turborepo for updates: https://x.com/turborepo          │
╰──────────────────────────────────────────────────────────────────────────╯
turbo 2.6.1

• Packages in scope: @extension/content-script, @extension/dev-utils, @extension/hmr, @extension/i18n, @extension/options, @extension/schema-utils, @extension/shared, @extension/sidepanel, @extension/storage, @extension/tailwindcss-config, @extension/tsconfig, @extension/ui, @extension/vite-config, @extension/zipper, chrome-extension
• Running ready in 15 packages
• Remote caching disabled
┌─ @extension/zipper#ready > cache hit, replaying logs 3b84c6fe796e6b94

> @extension/zipper@0.1.13 ready C:\Users\admin\Documents\GitHub\一所\20251216GUIA
gent\code\nanobrowser\packages\zipper
> tsc
└─ @extension/zipper#ready ──
┌─ @extension/schema-utils#ready > cache hit, replaying logs 9a2685864b6b4c6e

> @extension/schema-utils@0.1.13 ready C:\Users\admin\Documents\GitHub\一所\202512
16GUIAgent\code\nanobrowser\packages\schema-utils
> node build.mjs
▲ [WARNING] The glob pattern "./lib/**/*.tsx" did not match any files [empty-glob]
└─ @extension/schema-utils#ready ──
┌─ @extension/ui#ready > cache hit, replaying logs fa659617133d6a08

> @extension/ui@0.1.13 ready C:\Users\admin\Documents\GitHub\一所\20251216GUIAgent
\code\nanobrowser\packages\ui
> node build.mjs
└─ @extension/ui#ready ──
┌─ @extension/hmr#ready > cache hit, replaying logs 8482a77f486dc064

> @extension/hmr@0.1.13 ready C:\Users\admin\Documents\GitHub\一所\20251216GUIAgen
t\code\nanobrowser\packages\hmr
> pnpm run build:tsc && pnpm run build:rollup

> @extension/hmr@0.1.13 build:tsc C:\Users\admin\Documents\GitHub\一所\20251216GUI
Agent\code\nanobrowser\packages\hmr
> tsc -b tsconfig.build.json

> @extension/hmr@0.1.13 build:rollup C:\Users\admin\Documents\GitHub\一所\20251216
GUIAgent\code\nanobrowser\packages\hmr
> rollup --config rollup.config.mjs


lib/injections/reload.ts → build/injections/reload.js...
created build/injections/reload.js in 76ms

lib/injections/refresh.ts → build/injections/refresh.js...
created build/injections/refresh.js in 28ms
└─ @extension/hmr#ready ──
┌─ @extension/storage#ready > cache hit, replaying logs a1351824a9326520

> @extension/storage@0.1.13 ready C:\Users\admin\Documents\GitHub\一所\20251216GUI
Agent\code\nanobrowser\packages\storage
> node build.mjs
└─ @extension/storage#ready ──
┌─ @extension/i18n#ready > cache hit, replaying logs 5d12c6bf8808a018

> @extension/i18n@0.1.13 ready C:\Users\admin\Documents\GitHub\fri\20251216GUIAgen
t\code\nanobrowser\packages\i18n
> pnpm genenrate-i8n && node build.dev.mjs

> @extension/i18n@0.1.13 genenrate-i8n C:\Users\admin\Documents\GitHub\fri\2025121
6GUIAgent\code\nanobrowser\packages\i18n
> node genenrate-i18n.mjs
I18n build complete
└─ @extension/i18n#ready ──
┌─ @extension/shared#ready > cache hit, replaying logs a2852fe26689b97f

> @extension/shared@0.1.13 ready C:\Users\admin\Documents\GitHub\一所\20251216GUIA
gent\code\nanobrowser\packages\shared
> node build.mjs
└─ @extension/shared#ready ──
┌─ @extension/dev-utils#ready > cache hit, replaying logs 40af497709d0761c

> @extension/dev-utils@0.1.13 ready C:\Users\admin\Documents\GitHub\一所\20251216G
UIAgent\code\nanobrowser\packages\dev-utils
> tsc
└─ @extension/dev-utils#ready ──

 Tasks:    8 successful, 8 total
Cached:    8 cached, 8 total
  Time:    441ms >>> FULL TURBO

╭──────────────────────────────────────────────────────────────────────────╮                                   
│                                                                          │
│                     Update available v2.6.1 ≫ v2.7.4                     │
│    Changelog: https://github.com/vercel/turborepo/releases/tag/v2.7.4    │
│          Run "pnpm dlx @turbo/codemod@latest update" to update           │
│                                                                          │
│          Follow @turborepo for updates: https://x.com/turborepo          │
╰──────────────────────────────────────────────────────────────────────────╯
turbo 2.6.1

 WARNING  daemon is required for watch, ignoring request to disable daemon
• Packages in scope: @extension/content-script, @extension/dev-utils, @extension/hmr, @extension/i18n, @extension/options, @extension/schema-utils, @extension/shared, @extension/sidepanel, @extension/storage, @extension/tailwindcss-config, @extension/tsconfig, @extension/ui, @extension/vite-config, @extension/zipper, chrome-extension
• Running dev in 15 packages
• Remote caching disabled
  × Failed to connect to daemon.
  ╰─▶ unable to connect to daemon after 3 retries

 ELIFECYCLE  Command failed with exit code 1.
(base) PS C:\Users\admin\Documents\GitHub\fri\20251216GUIAgent\code\nanobrowser>
```

尝试：

```powershell
(base) PS C:\Users\admin\Documents\GitHub\fri\20251216GUIAgent\code\nanobrowser> npx turbo daemon stop
╭──────────────────────────────────────────────────────────────────────────╮
│                                                                          │
│                     Update available v2.6.1 ≫ v2.7.4                     │
│    Changelog: https://github.com/vercel/turborepo/releases/tag/v2.7.4    │
│          Run "pnpm dlx @turbo/codemod@latest update" to update           │
│                                                                          │
│          Follow @turborepo for updates: https://x.com/turborepo          │
╰──────────────────────────────────────────────────────────────────────────╯
turbo 2.6.1

  × unable to connect: unable to connect to daemon after 3 retries
  ╰─▶ unable to connect to daemon after 3 retries
```

重启电脑。成功。

## 配置大模型 api

- provider: deepseek
- model_name: deepseek-chat
- base_url: https://api.deepseek.com
- api_key: sk-6fda4f18a54140c6ae408fdd13cfe97d

## 验证互联网结果

成功
- 成功执行任务
- 成功看到我添加的信息
	- 但不知为何只出现了一次，我原以为每次调用plan都会出现
	- 不过后面也没有两个assistant message相连的情况了，所以没事

## 验证内网结果

拷贝 dist 文件夹

# 实验结果

成功在内网运行