# 实验背景

在浏览微信公众号时，无意间看到了 stagehand 。发现正是我需要的。所以需要调研它

# 实验目的

调研 stagehand

# 实验步骤

## 在 win11 上跑通 stagehand

### 安装代码

```powershell
npx create-browser-app
cd my-stagehand-app # Enter the project directory
cp .env.example .env  # Add your API keys。否则执行 npm start 报错
npm install # 必须。否则报找不到txs的错误
```

### 修改代码

index.ts: 改为使用本地浏览器和国产模型
```typescript
const stagehand = new Stagehand({
env: "LOCAL",
model: "deepseek/deepseek-chat"
});
```

.env 配置本地大模型的api key
```typescript
DEEPSEEK_API_KEY="sk-4faeff95503c474e96d8e4252b77d387"
```

### 运行代码

```powershell
npm start
```

## 明确 agent 模式的流程是什么

### 弄懂如何 debug 代码

一直无法debug，后来经过魏鹏的指点，好像懂了，应该是必须把 stagehand 的源代码拉下来，才能调试到 stagehand 源码里面去。

## 安装 stagehand 源码

```powershell
git clone https://github.com/browserbase/stagehand.git
cd stagehand
$env:PUPPETEER_SKIP_DOWNLOAD="true"  // 跳过浏览器下载。否则pnpm install报错
pnpm install
pnpm run build
```

## 编写示例文件

创建 packages/core/examples/my_example.ts 如下：

```typescript
import { Stagehand } from "../lib/v3";

async function main() {
  const stagehand = new Stagehand({
    env: "LOCAL",
    model: "deepseek/deepseek-chat"
  });

  await stagehand.init();

  console.log(`Stagehand Session Started`);
  console.log(`Watch live: https://browserbase.com/sessions/${stagehand.browserbaseSessionID}`);

  const page = stagehand.context.pages()[0];

  await page.goto("https://stagehand.dev");

  const extractResult = await stagehand.extract("Extract the value proposition from the page.");
  console.log(`Extract result:\n`, extractResult);

  await stagehand.close();
}

main().catch((err) => {
  console.error(err);
  process.exit(1);
});
```

## 配置环境变量

```powershell
$env:DEEPSEEK_API_KEY = "sk-4faeff95503c474e96d8e4252b77d387"
```

若想要永久生效：

```powershell
[System.Environment]::SetEnvironmentVariable("DEEPSEEK_API_KEY", "sk-4faeff95503c474e96d8e4252b77d387", "User")
```

设置完成后，必须关闭并重新打开当前的 PowerShell 窗口或 VS Code 等编辑器，新变量才会生效。

## 运行代码

```powershell
cd C:\Users\admin\Documents\GitHub\一所\20251216GUIAgent\GUI_Agent效果录屏\实验47：调研stagehand\stagehand\packages\core
npx tsx examples/my_example.ts
```

## 代码解读

核心代码：
```typescript
const result = await this.llmClient.generateText({
  model: wrappedModel,
  system: systemPrompt,
  messages,
  tools: allTools,
  stopWhen: (result) => this.handleStop(result, maxSteps),
  temperature: 1,
  toolChoice: "auto",
  prepareStep: this.createPrepareStep(callbacks?.prepareStep),
  onStepFinish: this.createStepHandler(state, callbacks?.onStepFinish),
  abortSignal: preparedOptions.signal,
  providerOptions: wrappedModel.modelId.includes("gemini-3")
    ? {
        google: {
          mediaResolution: "MEDIA_RESOLUTION_HIGH",
        },
      }
    : undefined,
});
```

`generateText`函数完成了整个agent操作过程。它是 vercel/ai 的函数，内部实现了循环过程。

# 实验结果

成功完成调研。没有发现可以进一步挖掘的有意义的事情。