核心：通过添加人类操作轨迹上下文（纯文本）作为长期记忆。

```typescript
webpack://Agent/src/background/handlers/ExecutionHandler.ts
    workflow = teachModeService.getWorkflow(workflowId)
    this.execution.updateOptions({
        mode: 'teach',
        workflow: workflow
    })
    this.execution.run()  // 调用 webpack://Agent/src/lib/execution/Execution.ts/Execution/run()

webpack://Agent/src/lib/execution/Execution.ts
    Execution
        run()
            teachAgent.execute(this.options.workflow)  // 调用 webpack://Agent/src/lib/agent/TeachAgent.ts/execute()

webpack://Agent/src/lib/agent/TeachAgent.ts
    execute(workflow)
        this._executeDynamic(semanticWorkflow)  // 调用 webpack://Agent/src/lib/agent/TeachAgent.ts/_executeDynamic()

webpack://Agent/src/lib/agent/TeachAgent.ts
    _executeDynamic(workflow)
        this._runDynamicPlanner(workflow);

webpack://Agent/src/lib/agent/TeachAgent.ts
    _runDynamicPlanner(workflow)
        const userTrajectory = `Contextual User Trajectory mentioned by user for reference: ${workflow.metadata.description} ${JSON.stringify(userTrajectorySteps)}`;
        "Contextual User Trajectory mentioned by user for reference: The user navigated through the BrowserOS-agent GitHub repository, entering the 'chat-actions' subdirectory under '/apps/agent/lib', opened the 'types.ts' file to examine its TypeScript interfaces and function declarations, interacted with the code viewer to maintain focus, and subsequently switched to a new tab to execute a Baidu search after completing their code analysis. [{\"intent\":\"Access the source code files within the `lib` directory of the BrowserOS-agent project to prepare for subsequent actions such as viewing, analyzing, or modifying specific files.\",\"action\":{\"type\":\"session_start\",\"description\":\"Navigate to the GitHub repository directory for BrowserOS-agent at a specific commit hash, focusing on the `/apps/agent/lib` path. This establishes the starting context for exploring or interacting with files in this directory.\",\"validationStrategy\":\"Verify that the current URL matches 'https://github.com/browseros-ai/BrowserOS-agent/tree/27124baccb67276b0ef2a5a05a0702991b9f979d/apps/agent/lib' and that the page title contains 'BrowserOS-agent/apps/agent/lib'. Confirm the presence of visible file and directory entries such as 'analytics', 'env.ts', and 'getCurrentYear.ts' in the file list.\",\"timeoutMs\":30000}},{\"intent\":\"Navigate into the 'chat-actions' subdirectory within the '/apps/agent/lib' directory to explore or access its contents as part of a broader codebase navigation workflow.\",\"action\":{\"type\":\"click\",\"description\":\"Click on the 'chat-actions' directory in the file listing to navigate into it.\",\"nodeIdentificationStrategy\":\"The target element is an anchor link containing the text 'chat-actions, (Directory)' located in the file listing table. It appears in the row with commit history referencing '#137'.\",\"validationStrategy\":\"Verify that the URL has updated to include '/chat-actions' at the end, and confirm that the page title or breadcrumb still reflects the correct repository path. Additionally, check that the file listing now shows contents specific to the 'chat-actions' directory (though this may require waiting for dynamic content loading).\",\"timeoutMs\":5000}},{\"intent\":\"The user is navigating through the project structure to examine specific source code files. After entering the 'chat-actions' directory, they are now opening 'types.ts', likely to inspect type definitions or interfaces used in the chat functionality of the agent.\",\"action\":{\"type\":\"click\",\"description\":\"Click on the 'types.ts' file link to open and view its contents in the GitHub repository.\",\"nodeIdentificationStrategy\":\"Identify the link by its visible text content 'types.ts' within the file listing table, which appears after the 'chat-actions' directory entry and before other subdirectories like 'constants'.\",\"validationStrategy\":\"Verify that the URL has updated to include '/blob/' and ends with '/types.ts', and confirm the page title includes 'types.ts' in the path. Additionally, check that the file's last commit information is visible (authored by DaniAkash with message 'feat: agent code in monorepo (#137)') to ensure the correct file loaded.\",\"timeoutMs\":5000}},{\"intent\":\"The user intends to engage more directly with the source code of 'types.ts', possibly to read, analyze, or prepare for editing or copying specific type interfaces or helper functions defined in the file.\",\"action\":{\"type\":\"click\",\"description\":\"Click on the file content area to focus or interact with the code in 'types.ts'. This action likely prepares for reading, copying, or further interaction with the type definitions.\",\"nodeIdentificationStrategy\":\"Identify the textarea element containing the file's source code by its role as the code display area, typically a visible `<textarea>` with class or context indicating it renders file content. Look for text content matching TypeScript interface definitions and ensure it is within the main code viewing pane.\",\"validationStrategy\":\"Verify that the page URL ends with '/apps/agent/lib/chat-actions/types.ts' and that the main content displays TypeScript code including interface declarations like 'interface BaseChatAction' and 'export interface AITabAction'. Confirm the presence of key elements such as the breadcrumbs showing the full path and interactive buttons like 'Raw', 'Copy raw file', and 'Blame' which indicate the file view is fully loaded.\",\"timeoutMs\":5000}},{\"intent\":\"The user is likely exploring options to interact with the code, such as copying specific sections, viewing symbols, or accessing IDE-style features via GitHub's interface. This action supports deeper inspection or reuse of type definitions and helper functions in the file.\",\"action\":{\"type\":\"click\",\"description\":\"Right-clicked on the code content in the 'types.ts' file to access a context menu for additional actions related to the source code.\",\"nodeIdentificationStrategy\":\"Target the textarea element containing the file's source code, identifiable by its role as the primary content display area for the file on GitHub, with visible text matching the TypeScript interface and function declarations.\",\"validationStrategy\":\"Verify that the context menu appears near the clicked position (x: 538, y: 408) and contains standard code editor options such as 'Copy', 'Find', or GitHub-specific actions like 'Ask Copilot about this file'. Confirm success if the menu is visible within 2 seconds after the click.\",\"timeoutMs\":5000}},{\"intent\":\"The user is navigating between tabs to return to the source code file they were previously examining. This action indicates a continuation of their code review workflow, specifically focusing on understanding the structure and implementation of chat actions within the BrowserOS-agent project.\",\"action\":{\"type\":\"tab_switched\",\"description\":\"Switch back to the GitHub tab containing the 'types.ts' file in the BrowserOS-agent repository to continue reviewing the type definitions and helper functions for chat actions.\",\"validationStrategy\":\"Verify that the current tab URL matches https://github.com/browseros-ai/BrowserOS-agent/blob/27124baccb67276b0ef2a5a05a0702991b9f979d/apps/agent/lib/chat-actions/types.ts and that the page title contains 'BrowserOS-agent/apps/agent/lib/chat-actions/types.ts at 27124ba'. Confirm visibility of key elements such as the file content textarea (nodeId [154]) and the 'Copy raw file' button (nodeId [149]).\",\"timeoutMs\":5000}},{\"intent\":\"The user is resuming code analysis in the 'types.ts' file after briefly switching to another tab (Baidu). The click action reactivates the code viewer/editor area, ensuring that keyboard or subsequent interactions will be directed to the correct context. This maintains continuity in their workflow of examining type definitions and helper functions related to chat actions in the BrowserOS agent.\",\"action\":{\"type\":\"click\",\"description\":\"Click on the code editor area to set focus back to the file content after returning from another tab.\",\"nodeIdentificationStrategy\":\"Target the textarea element containing the file's source code. It is the only visible textarea on the page and contains the full text content of 'types.ts', including interface declarations like `BaseChatAction` and `AITabAction`. The element has a unique role as the code display surface within GitHub’s file viewer.\",\"validationStrategy\":\"Verify that the current tab remains on the GitHub repository file view for 'types.ts' and that the code content is fully rendered and interactive. Confirm the presence and visibility of key code elements such as the `interface BaseChatAction` declaration within the textarea content. No navigation should occur as a result of this click—stay within the same file view.\",\"timeoutMs\":5000}},{\"intent\":\"The user intends to interact with the code in 'types.ts', possibly to read or select specific parts of the code. The right-click may have been intended to bring up a context menu for additional options like copying code or navigating symbols.\",\"action\":{\"type\":\"click\",\"description\":\"Click on the file content area to ensure it is focused for interaction.\",\"nodeIdentificationStrategy\":\"Identify the textarea containing the file content by its role as the code display area within the GitHub file viewer, located below the file path breadcrumbs and above the file metadata controls.\",\"validationStrategy\":\"Verify that the file content area is active by checking for cursor presence in the code or observing that keyboard navigation (like arrow keys) moves through the code lines. Alternatively, confirm that a context menu appears if right-clicking was intended.\",\"timeoutMs\":5000}},{\"intent\":\"The user intends to execute a web search on Baidu with a previously entered query. The click on the '百度一下' button finalizes and triggers the search operation.\",\"action\":{\"type\":\"click\",\"description\":\"Click the '百度一下' (Baidu Search) button to perform a search using the current input in the Baidu search box. This action submits the query and loads the search results page.\",\"nodeIdentificationStrategy\":\"Locate the button element containing the text '百度一下'. This is typically positioned adjacent to the main search input field on the Baidu homepage.\",\"validationStrategy\":\"Verify that a new tab or window has opened with a URL containing 'https://www.baidu.com/s?wd=' followed by the encoded search query. Confirm success by checking for the presence of search result elements such as '<div class=\\\"result\\\">', '<h3 class=\\\"t\\\">', or similar identifiers typical of Baidu's search results layout. Additionally, ensure the page title remains '百度一下，你就知道', which indicates successful navigation within the Baidu domain.\",\"timeoutMs\":10000}},{\"intent\":\"The user has finished their workflow, which began with inspecting code in a GitHub repository (specifically `types.ts` in the BrowserOS-agent project), then switched context to perform a Baidu search. The search was successfully executed in a new tab, and the results are now displayed. With no further actions required, this SESSION_END signifies the natural conclusion of the user's objective—likely retrieving information related to a query possibly inspired by the code inspection (e.g., understanding timestamp usage in chat actions).\",\"action\":{\"type\":\"session_end\",\"description\":\"End the current session as all tasks have been completed.\",\"validationStrategy\":\"Session end does not require validation of page state. Completion is confirmed by the absence of pending actions following a successful search operation and the logical conclusion of the observed workflow.\",\"timeoutMs\":0}}]"

        const messages = [
            new SystemMessage(systemPrompt),
            new HumanMessage(userTrajectory),
            new HumanMessage(userPrompt),
            browserStateMessage, // Browser state with screenshot
        ];

        const result = await invokeWithRetry<PlannerOutput>(
            structuredLLM,
            messages,
            3,
            { signal: this.executionContext.abortSignal }
        );
```