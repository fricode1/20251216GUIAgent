# 实验背景

实验14告诉我们，当文本框失去焦点时，会导致输入失效。所以我想知道文本框是否拥有焦点，或者当前焦点是什么。我本想通过浏览器的控制台获取，但是当操作控制台时，文本框的焦点马上失去，转移到了控制台。切换其他应用也会导致文本框焦点消失。

我意识到，通过代码控制浏览器时，就算切换应用，也不会导致文本框焦点消失。

所以我希望尝试在代码控制浏览器的同时，想办法查询焦点状态。

# 实验目的

在代码控制浏览器的同时查询焦点状态，希望“查询焦点状态”这件事不会影响焦点状态本身。

# 实验步骤

## 与大模型讨论“查询浏览器中元素焦点状态”这件事对焦点状态本身的影响。这是一个观测动作对观测对象是否有影响的问题。

在科学实验中，这种现象被称为“观测者效应（Observer Effect）”。它指的是：“查询浏览器中元素焦点状态”这件事对焦点状态本身的影响。这是一个观测动作对观测对象是否有影响的问题。该现象在很多科学领域都广泛存在：
- 量子力学的波函数坍塌：为了“看见”一个电子，你必须发射一个光子去撞击它，而这个撞击会彻底改变电子的动量或位置。
- 热力学的温度计悖论：当你用一支温度计测量一杯水的温度时，你测得的永远不是这杯水原本的温度。温度计自身也有热容。如果你把一支冷温度计放入热水中，温度计会吸收水的一部分热量，导致水的温度略微下降。你测得的是“水和温度计达到热平衡后的温度”，而非“测量前水的原始温度”。
- 社会心理学的霍桑效应：被观测者知道自己成为了关注焦点，这种心理暗示促使他们改变了自然状态下的行为模式。
- 软件工程：为了查浏览器焦点而打开控制台，这个“打开”动作本身就改变了“焦点状态”。

## 问大模型如何解决查询浏览器焦点时的观测者效应

通过代码控制浏览器。

## 问大模型：通过cdp_use查询当前焦点的方法

### 问 gemini

gemini不懂cdp_use

### 问豆包

```python
focused_node = await cdp.send.DOM.getFocusedNode()
if focused_node:
    print(f"当前焦点节点 ID: {focused_node['nodeId']}")
else:
    print("当前无焦点节点")
```

## 执行代码

```bash
(base) zhbli@zhbli-91C6A09QKX:~/projects/20251216GUIAgent/GUI_Agent效果录屏/实
验16：代码操作浏览器时的焦点转移情况$ python ./get_focused_node.py
正在操作目标: 中国铁路12306网站 (ID: A9AA2EAE9A0EC60132EBD86FD948F36D)
Traceback (most recent call last):
  File "/home/zhbli/projects/20251216GUIAgent/GUI_Agent效果录屏/实验16：代码操作浏览器时的焦点转移情况/./get_focused_node.py", line 92, in <module>
    asyncio.run(main())
    ~~~~~~~~~~~^^^^^^^^
  File "/home/zhbli/miniconda3/lib/python3.13/asyncio/runners.py", line 195, in run
    return runner.run(main)
           ~~~~~~~~~~^^^^^^
  File "/home/zhbli/miniconda3/lib/python3.13/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "/home/zhbli/miniconda3/lib/python3.13/asyncio/base_events.py", line 725, in run_until_complete
    return future.result()
           ~~~~~~~~~~~~~^^
  File "/home/zhbli/projects/20251216GUIAgent/GUI_Agent效果录屏/实验16：代码操作浏览器时的焦点转移情况/./get_focused_node.py", line 49, in main
    focused_node = await cdp.send.DOM.getFocusedNode()
                         ^^^^^^^^^^^^^^^^^^^^^^^^^^^
AttributeError: 'DOMClient' object has no attribute 'getFocusedNode'
(base) zhbli@zhbli-91C6A09QKX:~/projects/20251216GUIAgent/GUI_Agent效果录屏/实验16：代码操作浏览器时的
焦点转移情况$ 
```

## 豆包提供的另一种方法：通过js代码

```python
result = await cdp.send.Runtime.evaluate({
    "expression": """
        (function() {
            const focused = document.activeElement;
            if (!focused) return null;
            // 返回焦点元素的标签名、ID 和类名
            return {
                tagName: focused.tagName,
                id: focused.id,
                className: focused.className,
                outerHTML: focused.outerHTML.substring(0, 100)  // 截取部分 HTML
            };
        })()
    """,
    "returnByValue": True
})

if result["result"]["value"]:
    focused_info = result["result"]["value"]
    print("当前焦点元素信息：")
    print(f"标签名: {focused_info['tagName']}")
    print(f"ID: {focused_info['id']}")
    print(f"类名: {focused_info['className']}")
    print(f"HTML 片段: {focused_info['outerHTML']}")
else:
    print("当前无焦点元素")
```

报错：

```bash
(base) zhbli@zhbli-91C6A09QKX:~/projects/20251216GUIAgent/GUI_Agent效果录屏/实验16：代码操作浏览器时的
焦点转移情况$ python ./get_focused_node.py
正在操作目标: 中国铁路12306网站 (ID: A9AA2EAE9A0EC60132EBD86FD948F36D)
Traceback (most recent call last):
  File "/home/zhbli/projects/20251216GUIAgent/GUI_Agent效果录屏/实验16：代码操作浏览器时的焦点转移情况/./get_focused_node.py", line 107, in <module>
    asyncio.run(main())
    ~~~~~~~~~~~^^^^^^^^
  File "/home/zhbli/miniconda3/lib/python3.13/asyncio/runners.py", line 195, in run
    return runner.run(main)
           ~~~~~~~~~~^^^^^^
  File "/home/zhbli/miniconda3/lib/python3.13/asyncio/runners.py", line 118, in run
    return self._loop.run_until_complete(task)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "/home/zhbli/miniconda3/lib/python3.13/asyncio/base_events.py", line 725, in run_until_complete
    return future.result()
           ~~~~~~~~~~~~~^^
  File "/home/zhbli/projects/20251216GUIAgent/GUI_Agent效果录屏/实验16：代码操作浏览器时的焦点转移情况/./get_focused_node.py", line 49, in main
    result = await cdp.send.Runtime.evaluate({
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<14 lines>...
    })
    ^^
  File "/home/zhbli/miniconda3/lib/python3.13/site-packages/cdp_use/cdp/runtime/library.py", line 128, in evaluate
    return cast("EvaluateReturns", await self._client.send_raw(
                                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<3 lines>...
    ))
    ^
  File "/home/zhbli/miniconda3/lib/python3.13/site-packages/cdp_use/client.py", line 398, in send_raw
    return await future
           ^^^^^^^^^^^^
RuntimeError: {'code': -32601, 'message': "'Runtime.evaluate' wasn't found"}
```

说明豆包能力很差劲。

## 寻找在cdp_use中执行js代码的正确方法

实验10就做了这件事。

用的是 `cdp.send.Runtime.evaluate` 函数。

我对比了一下，发现就是这么用的，没有看出任何区别，而且实验10也能成功跑通。这是为什么？

想要调查原因很复杂。但是想获得正确结果很简单——直接把实验10代码替换即可。

我该怎么办？单步调试，寻找错误根源。

# 实验结果

中止。`cdp.send.Runtime.evaluate` 在实验10中能正确运行，但在本实验报错 'Runtime.evaluate' wasn't found。我要找到问题所在。