# 实验背景

agent操作12306浏览器填写时间框失效。填写操作是基本操作，如果这个操作都搞不定，将来能发挥什么大的作用呢？所以必须弄清楚究竟是怎么失效的。底层是用 cdp use 操作的。

# 实验目的

用 cdp_use 复现12306填写时间框失效。

# 实验步骤

## 浏览 cdp_use 代码

- https://github.com/browser-use/cdp-use
- 借助豆包。

## 跑通 cdp_use 代码

### 服务端

chromium --remote-debugging-port=9222

运行该命令，会得到监听地址，如：`ws://[::1]:9222/devtools/browser/7119b24e-4638-4d1f-89ec-06fae1f66be5`

### 客户端

```python

import asyncio
from cdp_use.client import CDPClient

async def main():
    # Connect to Chrome DevTools
    async with CDPClient("ws://[::1]:9222/devtools/browser/7119b24e-4638-4d1f-89ec-06fae1f66be5") as cdp:
        # Get all browser targets with full type safety
        targets = await cdp.send.Target.getTargets()
        print(f"Found {len(targets['targetInfos'])} targets")
        for target in targets["targetInfos"]:
            print(f"目标ID: {target['targetId']}, 标题: {target['title']}, URL: {target['url']}")

asyncio.run(main())
```

备注：`async with CDPClient("ws://[::1]:9222/devtools/browser/7119b24e-4638-4d1f-89ec-06fae1f66be5") as cdp:`

地址从服务端获取。

成功跑通。

## 跑通点击代码

成功。

### 坐标是什么意思？

在 CDP (Chrome DevTools Protocol) 中，坐标的参考系和行为逻辑如下，这对于开发 GUI Agent 非常关键：

### 1. 坐标参考系：视口 (Viewport)
CDP 的 `Input.dispatchMouseEvent` 和 `DOM.getBoxModel` 使用的是**视口坐标系 (Viewport Coordinates)**。
*   **原点 (0,0)**：位于浏览器内容区域（不包含标签栏、地址栏、书签栏）的**左上角**。
*   **单位**：CSS 像素。

---

### 2. 不同操作对坐标的影响

#### ① 拖动浏览器窗口（在桌面上移动）
*   **影响：无**。
*   **原因**：因为参考系是浏览器视口的左上角，而不是操作系统的屏幕左上角。无论你把浏览器拖到哪个显示器或哪个角落，元素在视口内的 `(x, y)` 坐标保持不变。

#### ② 滚动网页 (Scrolling)
*   **影响：有，坐标会动态变化**。
*   **原因**：`DOM.getBoxModel` 返回的是元素当前相对于视口的位置。
    *   如果一个按钮在页面顶部，坐标可能是 `(100, 100)`。
    *   当你向下滚动 50 像素后，再次调用 `getBoxModel`，它的坐标会变成 `(100, 50)`。
    *   **注意**：如果你发送点击指令给一个当前**不在视口内**（滚出去了）的坐标，点击可能会失效，或者点到了遮挡在上面的其他元素。

#### ③ 缩放页面 (Zooming, 如 Ctrl + '+')
*   **影响：有，但 CDP 会自动处理比例**。
*   **原因**：CDP 使用的是 **CSS 像素**。
    *   当你放大页面到 200% 时，元素占用的物理像素变多了，但它在布局中的逻辑 CSS 像素也会随之改变。
    *   关键点：**只要你在点击前瞬间调用 `DOM.getBoxModel` 获取坐标，拿到的就是当前缩放状态下的准确坐标**，直接发给 `Input` 即可，不需要手动计算缩放比。

#### ④ 调整浏览器窗口大小 (Resizing)
*   **影响：有，会导致重新布局 (Reflow)**。
*   **原因**：改变窗口宽度可能会触发响应式布局，导致按钮从左边跳到右边。
    *   **对策**：在执行点击动作前，重新调用一次 `querySelector` 和 `getBoxModel` 获取最新位置。

---

### 3. 开发 GUI Agent 的最佳实践

为了保证点击的 100% 准确，建议遵循以下流程：

1.  **确保元素在视口内**：
    在点击前，先调用 `DOM.scrollIntoViewIfNeeded`（通过 `Runtime.evaluate`）或者使用 CDP 的 `DOM.scrollToIntoView`。
    ```python
    # 伪代码：点击前先滚动到视野内
    await cdp.send.Runtime.evaluate({
        "expression": "document.querySelector('selector').scrollIntoView({block: 'center'})"
    }, sessionId=sid)
    ```

2.  **即拿即用**：
    不要缓存坐标。网页是动态的，坐标应该在 `Input.dispatchMouseEvent` 之前的几毫秒内通过 `getBoxModel` 获取。

3.  **处理“视口外”的情况**：
    如果 `getBoxModel` 返回的坐标是负数，或者大于视口高度（可以通过 `Page.getLayoutMetrics` 获取视口宽高），说明元素不可见，物理点击会失败。

### 总结
**CDP 的坐标是“所见即所得”的视口坐标。** 
*   **移动窗口**：不影响。
*   **滚动/缩放/调大小**：会改变数值。
*   **解决方案**：先执行 `scrollIntoView`，然后立即获取 `getBoxModel` 坐标并点击。