# 实验背景

DrissionPage 在 docker 中无法使用

# 实验目的

解决这一问题

# 实验步骤

## google：DrissionPage Docker

- 有专门 drisson 镜像

## drissionpage4-ubuntu-webdesktop-novnc 镜像

https://hub.docker.com/r/qiudeng/drissionpage4-ubuntu-webdesktop-novnc 提到，Python版本3.9，我尝试过使用更新的版本，但是因为未知原因没成功。

这说明很多问题是很奇葩的，莫名其妙。

失败：在容器的python中没有 DrissionPage

## 直接找 docker 的 浏览器

- kasmweb/chrome

## kasmweb/chrome

### 在 docker desktop 中点击启动按钮

https://172.17.0.7:4902/ 无法访问此网站
172.17.0.7 意外终止了连接。

### 在终端运行

docker run --rm -it --shm-size=512m -p 6901:6901 -e VNC_PW=password kasmweb/chrome:1.18.0-rolling-daily

必须使用 HTTPS。请在浏览器地址栏输入：https://localhost:6901
因为是自签名证书，浏览器会提示“您的连接不是私密连接”，点击“高级” -> “继续前往”即可。
默认用户名：kasm_user，密码：password（你在运行命令中设置的 VNC_PW）。

### 链接 DrissionPage 尝试1

docker run --rm -it `
  --shm-size=512m `
  -p 6901:6901 `
  -p 9222:9222 `
  -e VNC_PW=password `
  -e START_URL=https://www.google.com `
  kasmweb/chrome:1.18.0-rolling-daily

在浏览器输入 http://127.0.0.1:9222/json 该网页无法正常运作
127.0.0.1 未发送任何数据。

### 链接 DrissionPage 尝试2

docker run --rm -it `
  --shm-size=512m `
  -p 6901:6901 `
  -p 9222:9222 `
  -e VNC_PW=password `
  -e CHROME_ARGS="--remote-debugging-port=9222 --remote-debugging-address=0.0.0.0 --no-sandbox" `
  kasmweb/chrome:1.18.0-rolling-daily

在浏览器输入 http://127.0.0.1:9222/json 该网页无法正常运作
127.0.0.1 未发送任何数据。

## 我希望有一个容器，有浏览器，能够生成一个地址，ws://xxx:port 让我用 drissionPage 连接

docker run -d \
  -p 9222:3000 \
  --shm-size=2gb \
  -e "CONNECTION_TIMEOUT=600000" \
  --name my-chrome \
  browserless/chrome

打开浏览器，访问：http://localhost:9222
如果你看到一个 browserless 的管理界面，说明容器运行正常。
访问 http://localhost:9222/json，如果返回类似 [ { "description": "", "devtoolsFrontendUrl": ... } ] 的 JSON 数据，说明调试端口已开放。

drissionpage调用报错：
出现这个错误 WebSocketBadStatusException: Handshake status 404 Not Found 的原因是：
browserless/chrome 镜像是一个“浏览器服务化”的工具。它默认在根目录提供的是一个管理界面或 API，而不是直接的 Chrome 调试端口。当 DrissionPage 尝试按照标准 Chrome 的方式去寻找调试接口时，被 browserless 的路由拦截导致了 404。
为了让 DrissionPage 像连接本地浏览器一样简单地连接容器，我建议你换成 标准的 Chromium 镜像（如 zenika/alpine-chrome）

## 使用 zenika/alpine-chrome

docker run -d `
  --name my-chrome `
  -p 9222:9222 `
  --rm `
  zenika/alpine-chrome `
  --no-sandbox `
  --remote-debugging-address=0.0.0.0 `
  --remote-debugging-port=9222 `
  --disable-gpu `
  --disable-dev-shm-usage `
  about:blank

浏览器验证：访问 http://localhost:9222/json。

drissionpage启动的是本地的浏览器。因为连接的瞬间，容器停止了。这和一开始情况一样。

## 试试 wsl 子系统

进的是 docker 的 wsl 且没有 apt


## 试试在文字界面用 playwright 启动无头浏览器

成功

## 试试 ubuntu 文字界面能不能行

chromium --headless --disable-gpu --remote-debugging-port=9222 --no-sandbox

成功

运行 DrissionPage 连接

失败

## 试试 ubuntu 图形界面运行无头浏览器行不行

google-chrome --headless=new --no-sandbox --disable-gpu --remote-debugging-port=9222 --disable-dev-shm-usage --remote-debugging-address=0.0.0.0

失败

## 查看 drissionpage 文档

在ubuntu文字界面(ctrl+alt+f4)中，直接运行 

```python
from DrissionPage import Chromium
tab = Chromium().latest_tab
tab.get('https://www.baidu.com')
```

即可成功

在容器中，失败：

```
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
  File "/usr/local/lib/python3.10/site-packages/DrissionPage/_base/chromium.py", line 41, in __new__
    is_headless, browser_id, is_exists, ws_only = run_browser(opt)
  File "/usr/local/lib/python3.10/site-packages/DrissionPage/_base/chromium.py", line 501, in run_browser
    is_exists = connect_browser(chromium_options)
  File "/usr/local/lib/python3.10/site-packages/DrissionPage/_functions/browser.py", line 58, in connect_browser
    raise BrowserConnectError(ADDRESS=address, TIP=_S._lang.BROWSER_CONNECT_ERR_INFO)
DrissionPage.errors.BrowserConnectError: 
The browser connection fails.
Address: 127.0.0.1:9222
Tip: 
1, the user folder does not conflict with the open browser 
2, if no interface system, please add '--headless=new' startup parameter 
3, if the system is Linux, try adding '--no-sandbox' boot parameter 
The port and user folder paths can be set using ChromiumOptions.
Version: 4.1.1.2
```

重启电脑，报错2：

```
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
  File "/usr/local/lib/python3.10/site-packages/DrissionPage/_base/chromium.py", line 41, in __new__
    is_headless, browser_id, is_exists, ws_only = run_browser(opt)
  File "/usr/local/lib/python3.10/site-packages/DrissionPage/_base/chromium.py", line 501, in run_browser
    is_exists = connect_browser(chromium_options)
  File "/usr/local/lib/python3.10/site-packages/DrissionPage/_functions/browser.py", line 58, in connect_browser
    raise BrowserConnectError(ADDRESS=address, TIP=_S._lang.BROWSER_CONNECT_ERR_INFO)
DrissionPage.errors.BrowserConnectError:
The browser connection fails.
Address: 127.0.0.1:9222
Tip:
1, the user folder does not conflict with the open browser
2, if no interface system, please add '--headless=new' startup parameter
3, if the system is Linux, try adding '--no-sandbox' boot parameter
The port and user folder paths can be set using ChromiumOptions.
Version: 4.1.1.2
```

修改python代码：

```python
from DrissionPage import Chromium, ChromiumOptions

# 创建配置对象
co = ChromiumOptions()

# 1. 必须：设置无头模式（在没有图形界面的容器中运行）
co.set_argument('--headless=new') 

# 2. 必须：禁用沙盒（Docker 默认权限限制，不加这个启动会报错）
co.set_argument('--no-sandbox')

# 3. 建议：禁用 GPU（减少在容器环境中的资源冲突）
co.set_argument('--disable-gpu')

# 4. 建议：解决容器内 /dev/shm 分区过小导致浏览器崩溃的问题
co.set_argument('--disable-dev-shm-usage')

# 传入配置启动
tab = Chromium(co).latest_tab
tab.get('https://www.baidu.com')
print(tab.title)
```

失败：

```
Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
  File "/usr/local/lib/python3.10/site-packages/DrissionPage/_base/chromium.py", line 96, in __init__
    self._driver = BrowserDriver(self.id, self._ws_address, self)
  File "/usr/local/lib/python3.10/site-packages/DrissionPage/_base/driver.py", line 214, in __init__
    super().__init__(_id, address, owner)
  File "/usr/local/lib/python3.10/site-packages/DrissionPage/_base/driver.py", line 49, in __init__
    self.start()
  File "/usr/local/lib/python3.10/site-packages/DrissionPage/_base/driver.py", line 159, in start
    self._ws = create_connection(self.address, enable_multithread=True, suppress_origin=True)
  File "/usr/local/lib/python3.10/site-packages/websocket/_core.py", line 664, in create_connection
    websock.connect(url, **options)
  File "/usr/local/lib/python3.10/site-packages/websocket/_core.py", line 268, in connect
    self.handshake_response = handshake(self.sock, url, *addrs, **options)
  File "/usr/local/lib/python3.10/site-packages/websocket/_handshake.py", line 66, in handshake
    status, resp = _get_resp_headers(sock)
  File "/usr/local/lib/python3.10/site-packages/websocket/_handshake.py", line 158, in _get_resp_headers
    raise WebSocketBadStatusException(
websocket._exceptions.WebSocketBadStatusException: Handshake status 404 Not Found -+-+- {'content-length': '0', 'content-type': 'text/html'} -+-+- b''
```

安装依赖：

```
apt-get update && apt-get install -y \
    fonts-liberation \
    libnss3 \
    libasound2 \
    libgbm1 \
    libnspr4 \
    xdg-utils \
    libu2f-udev \
    libvulkan1 \
    fonts-noto-cjk  # 如果你需要渲染中文，这个很重要
```

修改python代码：

```python
import os
from DrissionPage import Chromium, ChromiumOptions

# 1. 设置配置
co = ChromiumOptions()

# --- 基础 Docker 配置 ---
co.set_argument('--headless=new')       # 无头模式
co.set_argument('--no-sandbox')         # 禁用沙盒（root运行必须）
co.set_argument('--disable-gpu')        # 禁用GPU
co.set_argument('--disable-dev-shm-usage') # 解决共享内存不足

# --- 进阶稳定性配置（解决 404 问题） ---
# 忽略证书错误
co.set_argument('--ignore-certificate-errors')
# 禁用首次运行欢迎页（防止弹出新 Tab 干扰）
co.set_argument('--no-first-run')
co.set_argument('--no-default-browser-check')
# 禁用密码存储弹出
co.set_argument('--password-store=basic')

# 2. 【关键】指定一个固定的、有权限的用户数据目录
# DrissionPage 默认使用临时目录，在 Docker 中容易出错
co.set_user_data_path('/root/drission_user_data')

# 3. 【关键】显式指定端口，防止自动分配端口时的竞争
co.set_local_port(9222)
co.set_argument('--remote-debugging-port=9222')
co.set_argument('--remote-debugging-address=127.0.0.1')

# 4. 启动
try:
    print("正在启动浏览器...")
    browser = Chromium(co)
    tab = browser.latest_tab
    
    print("正在访问百度...")
    tab.get('https://www.baidu.com', timeout=10)
    print("标题:", tab.title)
    
    # 截图验证（可选，查看是否渲染成功）
    # tab.get_screenshot('/root/test.jpg')
    
    browser.quit()
except Exception as e:
    print(f"发生错误: {e}")
```

报错：

```text
正在启动浏览器...
发生错误: Handshake status 404 Not Found -+-+- {'content-length': '0', 'content-type': 'text/html'} -+-+- b''
```

wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb

sudo dpkg -i google-chrome-stable_current_amd64.deb

google-chrome --version --no-sandbox

还是不行


## https://www.bilibili.com/video/BV1QFaHzyE9m/?vd_source=5b497ba47d53a5e4d0a03683baf6b728

必须在ubuntu中运行

终于成功了

# 实验结果

B站的方法可行