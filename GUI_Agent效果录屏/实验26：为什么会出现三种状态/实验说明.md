# 实验背景

【情况1】点击 + 清空 + change = 失去焦点

```JavaScript
var iframe = document.createElement('iframe');
document.body.appendChild(iframe);
console.log = iframe.contentWindow.console.log;
var el = document.getElementById('train_date');
el.focus();
el.click();  // 弹出日历框
el.value = "";
console.log(document.activeElement == el)  // true
el.dispatchEvent(new Event("input", { bubbles: true }));
console.log(document.activeElement == el)  // true
el.dispatchEvent(new Event("change", { bubbles: true }));
console.log(document.activeElement == el)  // false
```

【情况2】无点击 + 清空 + change = 不失去焦点

```JavaScript
var iframe = document.createElement('iframe');
document.body.appendChild(iframe);
console.log = iframe.contentWindow.console.log;
var el = document.getElementById('train_date');
el.focus();
//el.click();
el.value = "";
console.log(document.activeElement == el)  // true
el.dispatchEvent(new Event("input", { bubbles: true }));
console.log(document.activeElement == el)  // true
el.dispatchEvent(new Event("change", { bubbles: true }));
console.log(document.activeElement == el)  // true
```

【情况3】点击 + 清空 + 不change = 不失去焦点

```JavaScript
var iframe = document.createElement('iframe');
document.body.appendChild(iframe);
console.log = iframe.contentWindow.console.log;
var el = document.getElementById('train_date');
el.focus();
el.click();  // 弹出日历框
el.value = "";
console.log(document.activeElement == el)  // true
el.dispatchEvent(new Event("input", { bubbles: true }));
console.log(document.activeElement == el)  // true
// el.dispatchEvent(new Event("change", { bubbles: true }));
console.log(document.activeElement == el)  // true
```

为什么会出现这三种情况？

# 实验目的

寻找三种情况原因

# 实验步骤

## 问gemini

（已经实际验证）不click则不弹出日历。click则弹出日历。

## 是不是网站自有的js导致的？能不能从网站自有js代码中找到原因？

通过分析12306的业务代码 main_v60012.js，gemini回答失去焦点原因：

el.click()：触发了 #train_date 绑定的点击事件。根据源码，这会执行 dateTrainTwo 里的逻辑，正式初始化日历插件。此时，插件执行了 el.onchange = onpicked。

el.value = ""：只是修改了值，由于是脚本修改，不会触发原生 change。

el.dispatchEvent(new Event("change"))：手动派发了 change 事件。

触发逻辑：由于步骤1已经把 onpicked 挂载到了 onchange 上，此时 onpicked 被执行。

执行 blur()：onpicked 内部执行了 $(dataValue).blur()。

结论：焦点主动丢失。

# 实验结果

彻底弄懂了原因，是前端业务逻辑脚本导致的。